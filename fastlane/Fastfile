default_platform(:android)

desc "Runs tests"
lane :test do
gradle(task: "test")
end

  desc "Pull Build number from play store, increment and update gradle."
  lane :updateBuildVersion do
     code = google_play_track_version_codes(package_name: ENV['PACKAGE_NAME'],track: "internal")

     # Handle case where only one build exists (mobile only)
     if code.length >= 2
       # Both mobile and TV builds exist
       mobile_version = code[1] + 1
       tv_version = mobile_version + 1
     else
       # Only mobile build exists
       mobile_version = (code[0] || 0) + 1
       tv_version = mobile_version + 1
     end

     increment_version_code(
        gradle_file_path: "mobile/build.gradle",
        app_folder_name:"mobile",
        version_code: mobile_version
  )
      increment_version_code(
         gradle_file_path: "tv/build.gradle",
         app_folder_name:"tv",
         version_code: tv_version
  )
  end

   desc "Pull Build number from play store and update gradle with same."
    lane :keepBuildVersion do
       code = google_play_track_version_codes(package_name: ENV['PACKAGE_NAME'],track: "internal")

       # Handle case where only one build exists (mobile only)
       if code.length >= 2
         # Both mobile and TV builds exist
         mobile_version = code[0]
         tv_version = code[1]
       else
         # Only mobile build exists
         mobile_version = code[0] || 0
         tv_version = mobile_version + 1
       end

       increment_version_code(
          gradle_file_path: "mobile/build.gradle",
          app_folder_name:"mobile",
          version_code: mobile_version
    )
        increment_version_code(
           gradle_file_path: "tv/build.gradle",
           app_folder_name:"tv",
           version_code: tv_version
    )
    end

  desc "Build and sign"
  lane :buildAndSign do |options|
    gradle(
    task: options[:task],
    flavor: "google",
    build_type: "Release",
    print_command: false
 )
 end

 desc "Build debug apk"
   lane :buildAndDebug do
     gradle(task: "assemble",
     flavor: "google",
     build_type: "Debug",
     print_command: false
  )
  end

  desc "Publish app to play store (Internal channel)"
  lane :publishToInternal do
    buildAndSign(task:"clean bundle")

    # Upload to Internal App Sharing first (for quick testing URLs)
    mobile_share_url = upload_to_play_store_internal_app_sharing(
      package_name: ENV['PACKAGE_NAME'],
      aab: "mobile/build/outputs/bundle/googleRelease/mobile-google-release.aab"
    )

    tv_share_url = upload_to_play_store_internal_app_sharing(
      package_name: ENV['PACKAGE_NAME'],
      aab: "tv/build/outputs/bundle/googleRelease/tv-google-release.aab"
    )

    # Print Internal App Sharing URLs
    UI.success("âœ… Internal App Sharing URLs (quick share):")
    UI.success("ðŸ“± Mobile: #{mobile_share_url}")
    UI.success("ðŸ“º TV: #{tv_share_url}")

    # Then upload to Internal track (standard release process)
    supply(
      version_name: ENV['VERSION_NAME'],
      track: "internal",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      aab_paths: Actions.lane_context[SharedValues::GRADLE_ALL_AAB_OUTPUT_PATHS],
      mapping_paths: [
        "mobile/build/outputs/mapping/googleRelease/mapping.txt",
        "tv/build/outputs/mapping/googleRelease/mapping.txt"
      ]
    )

    UI.success("âœ… Also published to Internal testing track")

    # Send Slack notification with Internal App Sharing URLs
    if ENV['SLACK_URL']
      # Get last 5 commits
      commit_messages = changelog_from_git_commits(
        commits_count: 5,
        pretty: "â€¢ %s",
        merge_commit_filtering: "exclude_merges"
      )

      slack(
        message: "âœ… New build uploaded to Google Play Internal",
        slack_url: ENV['SLACK_URL'],
        payload: {
          "Version" => ENV['VERSION_NAME'],
          "Mobile URL" => mobile_share_url,
          "TV URL" => tv_share_url,
          "Recent Commits" => commit_messages
        },
        default_payloads: [:git_branch, :git_author],
        success: true
      )
    end
end

 desc "Build Signed Apks for all modules."
 lane :buildReleaseApk do
  buildAndSign(task:"mobile:assemble tv:assemble")
 end